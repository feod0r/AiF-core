import React, { useState, useEffect } from 'react';
import {
  Table,
  Button,
  Modal,
  Form,
  Input,
  Space,
  Popconfirm,
  message,
  Card,
  Typography,
  Tooltip,
  Select,
  InputNumber,
  Tag,
  DatePicker,
  List,
  Drawer,
} from 'antd';
import { PlusOutlined, EditOutlined, DeleteOutlined, CheckOutlined, CloseOutlined, PlayCircleOutlined, SwapOutlined } from '@ant-design/icons';
import { 
  inventoryMovementsApi, 
  itemsApi, 
  warehousesApi, 
  machinesApi,
  ownersApi,
  counterpartiesApi,
  accountsApi
} from '../services/api';
import { 
  InventoryMovement, 
  Item, 
  Warehouse, 
  Machine, 
  Owner, 
  Counterparty, 
  Account,
  BulkOperationResult,
  BulkMovementApproval,
  BulkMovementExecution
} from '../types';
import dayjs from 'dayjs';

const { Title } = Typography;
const { Option } = Select;
const { TextArea } = Input;

const InventoryMovements: React.FC = () => {
  const [movements, setMovements] = useState<InventoryMovement[]>([]);
  const [items, setItems] = useState<Item[]>([]);
  const [warehouses, setWarehouses] = useState<Warehouse[]>([]);
  const [machines, setMachines] = useState<Machine[]>([]);
  const [owners, setOwners] = useState<Owner[]>([]);
  const [counterparties, setCounterparties] = useState<Counterparty[]>([]);
  const [accounts, setAccounts] = useState<Account[]>([]);
  const [loading, setLoading] = useState(false);
  const [modalVisible, setModalVisible] = useState(false);
  const [editingMovement, setEditingMovement] = useState<InventoryMovement | null>(null);
  const [movementItems, setMovementItems] = useState<any[]>([]);
  const [selectedMovementType, setSelectedMovementType] = useState<string>('');
  const [forceUpdate, setForceUpdate] = useState(0);
  const [isMobile, setIsMobile] = useState(false);
  const [detailDrawerVisible, setDetailDrawerVisible] = useState(false);
  const [selectedMovement, setSelectedMovement] = useState<InventoryMovement | null>(null);
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 100,
    total: 0,
  });
  const [form] = Form.useForm();

  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  const [selectedRowKeys, setSelectedRowKeys] = useState<React.Key[]>([]);
  const [bulkLoading, setBulkLoading] = useState(false);

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
  useEffect(() => {
    const checkMobile = () => {
      setIsMobile(window.innerWidth <= 768);
    };

    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  // –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
  const shouldShowFromWarehouse = () => {
    return ['transfer', 'load_machine', 'issue', 'sale'].includes(selectedMovementType);
  };

  const shouldShowToWarehouse = () => {
    if (selectedMovementType === 'receipt') {
      // –î–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–ª–∞–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω –∞–≤—Ç–æ–º–∞—Ç
      const selectedToMachine = form.getFieldValue('to_machine_id');
      return !selectedToMachine;
    }
    return ['transfer', 'unload_machine', 'adjustment'].includes(selectedMovementType);
  };

  const shouldShowFromMachine = () => {
    return ['transfer', 'unload_machine', 'issue', 'sale'].includes(selectedMovementType);
  };

  const shouldShowToMachine = () => {
    if (selectedMovementType === 'receipt') {
      // –î–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω —Å–∫–ª–∞–¥
      const selectedToWarehouse = form.getFieldValue('to_warehouse_id');
      return !selectedToWarehouse;
    }
    return ['transfer', 'load_machine', 'adjustment'].includes(selectedMovementType);
  };

  const shouldShowCounterparty = () => {
    return ['receipt', 'sale', 'load_machine'].includes(selectedMovementType);
  };

  // onChange –¥–ª—è –ø–æ–ª–µ–π - —Ç–æ–ª—å–∫–æ –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–µ –≤ —Ä–∞–º–∫–∞—Ö transfer
  const handleFromWarehouseChange = (value: number | undefined) => {
    form.setFieldsValue({ from_warehouse_id: value });
    
    if (selectedMovementType === 'transfer') {
      // –î–ª—è transfer –æ—á–∏—â–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      form.setFieldsValue({ from_machine_id: undefined });
    } else if (selectedMovementType === 'load_machine' && value) {
      // –î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∞, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Å–∫–ª–∞–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è, —Ç–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç –Ω–µ –Ω—É–∂–µ–Ω
      form.setFieldsValue({ counterparty_id: undefined });
    }
  };
  
  const handleFromMachineChange = (value: number | undefined) => {
    form.setFieldsValue({ from_machine_id: value });
    
    if (selectedMovementType === 'transfer') {
      // –î–ª—è transfer –æ—á–∏—â–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      form.setFieldsValue({ from_warehouse_id: undefined });
    }
  };
  
  const handleToWarehouseChange = (value: number | undefined) => {
    form.setFieldsValue({ to_warehouse_id: value });
    
    if (selectedMovementType === 'transfer') {
      // –î–ª—è transfer –æ—á–∏—â–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
      form.setFieldsValue({ to_machine_id: undefined });
    } else if (selectedMovementType === 'receipt' && value) {
      // –î–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Å–∫–ª–∞–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è, –æ—á–∏—â–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
      form.setFieldsValue({ to_machine_id: undefined });
    }
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª–µ–π
    setForceUpdate(prev => prev + 1);
  };
  
  const handleToMachineChange = (value: number | undefined) => {
    form.setFieldsValue({ to_machine_id: value });
    
    if (selectedMovementType === 'transfer') {
      // –î–ª—è transfer –æ—á–∏—â–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
      form.setFieldsValue({ to_warehouse_id: undefined });
    } else if (selectedMovementType === 'receipt' && value) {
      // –î–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∞–≤—Ç–æ–º–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è, –æ—á–∏—â–∞–µ–º —Å–∫–ª–∞–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
      form.setFieldsValue({ to_warehouse_id: undefined });
    }
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª–µ–π
    setForceUpdate(prev => prev + 1);
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏
  const getStatusColor = (status: any) => {
    if (!status) return 'default';
    const statusName = status.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    switch (statusName.toLowerCase()) {
      case 'draft':
      case '—á–µ—Ä–Ω–æ–≤–∏–∫':
        return 'orange';
      case 'approved':
      case '—É—Ç–≤–µ—Ä–∂–¥–µ–Ω':
        return 'blue';
      case 'executed':
      case '–≤—ã–ø–æ–ª–Ω–µ–Ω':
        return 'green';
      case 'cancelled':
      case '–æ—Ç–º–µ–Ω–µ–Ω':
        return 'red';
      default:
        return 'default';
    }
  };

  const getStatusLabel = (status: any) => {
    if (!status) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    const statusName = status.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    switch (statusName.toLowerCase()) {
      case 'draft':
        return '–ß–µ—Ä–Ω–æ–≤–∏–∫';
      case 'approved':
        return '–£—Ç–≤–µ—Ä–∂–¥–µ–Ω';
      case 'executed':
        return '–í—ã–ø–æ–ª–Ω–µ–Ω';
      case 'cancelled':
        return '–û—Ç–º–µ–Ω–µ–Ω';
      default:
        return statusName;
    }
  };

  const canApprove = (movement: InventoryMovement) => {
    const statusName = movement.status?.name?.toLowerCase();
    return statusName === 'draft' || statusName === '—á–µ—Ä–Ω–æ–≤–∏–∫';
  };

  const canExecute = (movement: InventoryMovement) => {
    const statusName = movement.status?.name?.toLowerCase();
    return statusName === 'approved' || statusName === '—É—Ç–≤–µ—Ä–∂–¥–µ–Ω';
  };

  const canCancel = (movement: InventoryMovement) => {
    const statusName = movement.status?.name?.toLowerCase();
    return statusName === 'draft' || statusName === '—á–µ—Ä–Ω–æ–≤–∏–∫' || statusName === 'approved' || statusName === '—É—Ç–≤–µ—Ä–∂–¥–µ–Ω';
  };

  const fetchMovements = async (page = 1, pageSize = 100) => {
    setLoading(true);
    try {
      // –ë—ç–∫–µ–Ω–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç skip/limit, –∞ –Ω–µ page/limit
      const skip = (page - 1) * pageSize;
      
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
      const [data, total] = await Promise.all([
        inventoryMovementsApi.getList({ skip, limit: pageSize }),
        inventoryMovementsApi.getCount()
      ]);
      
      setMovements(data);
      setPagination({
        current: page,
        pageSize,
        total,
      });
    } catch (error) {
      message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–≤–∏–∂–µ–Ω–∏–π');
    } finally {
      setLoading(false);
    }
  };

  const fetchData = async () => {
    try {
      const [itemsData, warehousesData, machinesData, ownersData, counterpartiesData, accountsData] = await Promise.all([
        itemsApi.getList(),
        warehousesApi.getList(),
        machinesApi.getList(),
        ownersApi.getList(),
        counterpartiesApi.getList(),
        accountsApi.getList(),
      ]);
      
      setItems(itemsData);
      setWarehouses(warehousesData);
      setMachines(machinesData.data || machinesData);
      setOwners(ownersData.data || ownersData);
      setCounterparties(counterpartiesData);
      setAccounts(accountsData);
    } catch (error) {
      message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö');
    }
  };

  useEffect(() => {
    fetchData();
    fetchMovements();
  }, []);

  const handleCreate = () => {
    setEditingMovement(null);
    setMovementItems([]);
    setSelectedMovementType('');
    setModalVisible(true);
    form.resetFields();
    form.setFieldsValue({
      document_date: dayjs(),
      status_id: 1, // –ß–µ—Ä–Ω–æ–≤–∏–∫
      currency: 'RUB',
    });
  };

  const handleEdit = (record: InventoryMovement) => {
    setEditingMovement(record);
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º—ã (–Ω—É–∂–µ–Ω item_id, –∞ –Ω–µ –≤–ª–æ–∂–µ–Ω–Ω—ã–π item)
    const normalizedItems = (record.items || []).map((it: any, idx: number) => ({
      id: it.id ?? idx,
      item_id: it.item_id ?? it.item?.id,
      quantity: typeof it.quantity === 'string' ? parseFloat(it.quantity) : it.quantity,
      price: typeof it.price === 'string' ? parseFloat(it.price) : it.price,
      amount: typeof it.amount === 'string' ? parseFloat(it.amount) : it.amount,
      description: it.description || '',
    }));
    setMovementItems(normalizedItems);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è –ª–æ–≥–∏–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏
    setSelectedMovementType(record.movement_type || '');
    setModalVisible(true);

    // –§–æ–ª–ª–±–µ–∫–∏ ID –∏–∑ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
    const warehouse_id = (record as any).warehouse_id ?? (record as any).warehouse?.id;
    const machine_id = (record as any).machine_id ?? (record as any).machine?.id;
    const from_warehouse_id = (record as any).from_warehouse_id ?? (record as any).from_warehouse?.id;
    const to_warehouse_id = (record as any).to_warehouse_id ?? (record as any).to_warehouse?.id;
    const from_machine_id = (record as any).from_machine_id ?? (record as any).from_machine?.id;
    const to_machine_id = (record as any).to_machine_id ?? (record as any).to_machine?.id;
    const counterparty_id = (record as any).counterparty_id ?? (record as any).counterparty?.id;

    // –°—Ç–∞—Ç—É—Å: –±–µ—Ä–µ–º status_id –ª–∏–±–æ –∏–∑ status.id
    const status_id = (record as any).status_id ?? (record as any).status?.id;

    form.setFieldsValue({
      movement_type: record.movement_type,
      document_date: record.document_date ? dayjs(record.document_date) : dayjs(),
      status_id,
      warehouse_id,
      from_warehouse_id,
      to_warehouse_id,
      machine_id,
      from_machine_id,
      to_machine_id,
      counterparty_id,
      currency: record.currency || 'RUB',
      description: record.description,
    });
  };

  const handleDelete = async (id: number) => {
    try {
      await inventoryMovementsApi.delete(id);
      message.success('–î–≤–∏–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
      fetchMovements();
    } catch (error) {
      message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è');
    }
  };

  const handleApprove = async (movement: InventoryMovement) => {
    try {
      const userRaw = localStorage.getItem('user');
      const currentUser = userRaw ? JSON.parse(userRaw) : null;
      const approvedBy = currentUser?.id;
      if (!approvedBy) {
        message.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
        return;
      }
      await inventoryMovementsApi.approve(movement.id, { approved_by: approvedBy });
      message.success('–î–≤–∏–∂–µ–Ω–∏–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ');
      fetchMovements();
    } catch (error) {
      message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è');
    }
  };

  const handleExecute = async (movement: InventoryMovement) => {
    try {
      const userRaw = localStorage.getItem('user');
      const currentUser = userRaw ? JSON.parse(userRaw) : null;
      const executedBy = currentUser?.id;
      if (!executedBy) {
        message.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è');
        return;
      }
      await inventoryMovementsApi.execute(movement.id, { executed_by: executedBy });
      message.success('–î–≤–∏–∂–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');
      fetchMovements();
    } catch (error) {
      message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è');
    }
  };

  const handleCancel = async (movement: InventoryMovement) => {
    try {
      // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –æ—Ç–º–µ–Ω—ã –¥–≤–∏–∂–µ–Ω–∏—è
      message.success('–î–≤–∏–∂–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
      fetchMovements();
    } catch (error) {
      message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –¥–≤–∏–∂–µ–Ω–∏—è');
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  const handleBulkApprove = async () => {
    if (selectedRowKeys.length === 0) {
      message.warning('–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
      return;
    }

    try {
      setBulkLoading(true);
      const result = await inventoryMovementsApi.bulkApprove({
        approved_by: 1, // TODO: –ü–æ–ª—É—á–∏—Ç—å ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        movement_ids: selectedRowKeys.map(key => Number(key))
      });

      if (result.success_count > 0) {
        message.success(`–£—Å–ø–µ—à–Ω–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ ${result.success_count} –¥–≤–∏–∂–µ–Ω–∏–π`);
      }
      if (result.error_count > 0) {
        message.warning(`–û—à–∏–±–æ–∫: ${result.error_count}`);
      }

      setSelectedRowKeys([]);
      fetchMovements();
    } catch (error) {
      message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏');
    } finally {
      setBulkLoading(false);
    }
  };

  const handleBulkExecute = async () => {
    if (selectedRowKeys.length === 0) {
      message.warning('–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è');
      return;
    }

    try {
      setBulkLoading(true);
      const result = await inventoryMovementsApi.bulkExecute({
        executed_by: 1, // TODO: –ü–æ–ª—É—á–∏—Ç—å ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        movement_ids: selectedRowKeys.map(key => Number(key))
      });

      if (result.success_count > 0) {
        message.success(`–£—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ${result.success_count} –¥–≤–∏–∂–µ–Ω–∏–π`);
      }
      if (result.error_count > 0) {
        message.warning(`–û—à–∏–±–æ–∫: ${result.error_count}`);
      }

      setSelectedRowKeys([]);
      fetchMovements();
    } catch (error) {
      message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏');
    } finally {
      setBulkLoading(false);
    }
  };

  const onSelectChange = (newSelectedRowKeys: React.Key[]) => {
    setSelectedRowKeys(newSelectedRowKeys);
  };

  const rowSelection = {
    selectedRowKeys,
    onChange: onSelectChange,
  };

  const addMovementItem = () => {
    const newItem = {
      id: Date.now(),
      item_id: undefined,
      quantity: 0,
      price: 0,
      amount: 0,
      description: '',
    };
    setMovementItems([...movementItems, newItem]);
  };

  const removeMovementItem = (index: number) => {
    const newItems = movementItems.filter((_, i) => i !== index);
    setMovementItems(newItems);
  };

  const updateMovementItem = (index: number, field: string, value: any) => {
    const newItems = [...movementItems];
    newItems[index] = { ...newItems[index], [field]: value };
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º—É
    if (field === 'quantity' || field === 'price') {
      const quantity = field === 'quantity' ? value : newItems[index].quantity;
      const price = field === 'price' ? value : newItems[index].price;
      newItems[index].amount = (quantity || 0) * (price || 0);
    }
    
    setMovementItems(newItems);
  };

  const handleMovementTypeChange = (value: string) => {
    setSelectedMovementType(value);
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞ –¥–≤–∏–∂–µ–Ω–∏—è
    form.setFieldsValue({
      from_warehouse_id: undefined,
      to_warehouse_id: undefined,
      from_machine_id: undefined,
      to_machine_id: undefined,
      counterparty_id: undefined,
    });
  };

  const handleSubmit = async (values: any) => {
    if (movementItems.length === 0) {
      message.error('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –≤—ã–±—Ä–∞–Ω—ã
    const invalidItems = movementItems.filter(item => !item.item_id || !item.quantity || !item.price);
    if (invalidItems.length > 0) {
      message.error('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤');
      return;
    }

    // –ù–æ–≤–∞—è –±–∏–∑–Ω–µ—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
    const type = values.movement_type;
    const hasFromWarehouse = !!values.from_warehouse_id;
    const hasToWarehouse = !!values.to_warehouse_id;
    const hasFromMachine = !!values.from_machine_id;
    const hasToMachine = !!values.to_machine_id;
    const hasCounterparty = !!values.counterparty_id;
    
    const hasFrom = hasFromWarehouse || hasFromMachine;
    const hasTo = hasToWarehouse || hasToMachine;

    if (type === 'receipt') {
      if (!hasTo) {
        message.error('–î–ª—è –ø—Ä–∏—Ö–æ–¥–∞ —É–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
        return;
      }
      if (!hasCounterparty) {
        message.error('–î–ª—è –ø—Ä–∏—Ö–æ–¥–∞ —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ (–ø–æ—Å—Ç–∞–≤—â–∏–∫–∞)');
        return;
      }
    }
    
    if (['issue', 'sale'].includes(type)) {
      if (!hasFrom) {
        message.error('–î–ª—è —Ä–∞—Å—Ö–æ–¥–∞/–ø—Ä–æ–¥–∞–∂–∏ —É–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
        return;
      }
      if (type === 'sale' && !hasCounterparty) {
        message.error('–î–ª—è –ø—Ä–æ–¥–∞–∂–∏ —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ (–ø–æ–∫—É–ø–∞—Ç–µ–ª—è)');
        return;
      }
    }
    
    if (type === 'transfer') {
      if (!hasFrom || !hasTo) {
        message.error('–î–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —É–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
        return;
      }
    }
    
    if (type === 'load_machine') {
      if (!hasToMachine) {
        message.error('–î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∞ —É–∫–∞–∂–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
        return;
      }
    }
    
    if (type === 'unload_machine') {
      if (!hasFromMachine) {
        message.error('–î–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∞ —É–∫–∞–∂–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
        return;
      }
    }
    
    if (type === 'adjustment') {
      if (!hasFrom && !hasTo) {
        message.error('–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —É–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ (—Å–∫–ª–∞–¥ –∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç)');
        return;
      }
    }

    try {
      const totalAmount = movementItems.reduce((sum, item) => sum + Number(item.amount || 0), 0);
      
      const movementData = {
        ...values,
        document_date: values.document_date.toISOString(),
        total_amount: totalAmount,
        items: movementItems.map(item => ({
          item_id: item.item_id,
          quantity: item.quantity,
          price: item.price,
          amount: item.amount,
          description: item.description,
        })),
      };

      if (editingMovement) {
        await inventoryMovementsApi.update(editingMovement.id, movementData);
        message.success('–î–≤–∏–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
      } else {
        await inventoryMovementsApi.create(movementData);
        message.success('–î–≤–∏–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ');
      }

      setModalVisible(false);
      setMovementItems([]);
      setEditingMovement(null);
      setSelectedMovementType('');
      fetchMovements();
    } catch (error) {
      message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è');
    }
  };

  const handleTableChange = (pagination: any) => {
    fetchMovements(pagination.current, pagination.pageSize);
  };

  const getTypeColor = (type: string) => {
    switch (type) {
      case 'receipt': return 'green';
      case 'issue': return 'red';
      case 'transfer': return 'blue';
      case 'sale': return 'orange';
      case 'adjustment': return 'purple';
      case 'load_machine': return 'cyan';
      case 'unload_machine': return 'magenta';
      default: return 'default';
    }
  };

  const getTypeLabel = (type: string) => {
    switch (type) {
      case 'receipt': return '–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ';
      case 'issue': return '–í—ã–¥–∞—á–∞';
      case 'transfer': return '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ';
      case 'sale': return '–ü—Ä–æ–¥–∞–∂–∞';
      case 'adjustment': return '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞';
      case 'load_machine': return '–ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∞';
      case 'unload_machine': return '–í—ã–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∞';
      default: return type;
    }
  };

  const columns = [
    {
      title: '–î–∞—Ç–∞',
      dataIndex: 'document_date',
      key: 'document_date',
      render: (date: string) => dayjs(date).format('DD.MM.YYYY HH:mm'),
    },
    {
      title: '–¢–∏–ø',
      dataIndex: 'movement_type',
      key: 'movement_type',
      render: (type: string) => (
        <Tag color={getTypeColor(type)}>
          {getTypeLabel(type)}
        </Tag>
      ),
    },
    {
      title: '–°—Ç–∞—Ç—É—Å',
      dataIndex: 'status',
      key: 'status',
      render: (status: any) => (
        <Tag color={getStatusColor(status)}>
          {getStatusLabel(status)}
        </Tag>
      ),
    },
    {
      title: '–¢–æ–≤–∞—Ä—ã',
      key: 'items',
      render: (_: any, record: InventoryMovement) => {
        if (!record.items || record.items.length === 0) return '–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤';
        return record.items.map((item: any, index: number) => (
          <div key={index}>
            {item.item?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} - {item.quantity} {item.item?.unit || '—à—Ç'}
          </div>
        ));
      },
    },
    {
      title: '–°—É–º–º–∞',
      dataIndex: 'total_amount',
      key: 'total_amount',
      render: (amount: number, record: InventoryMovement) => {
        if (!amount) return '-';
        const currency = record.currency || 'RUB';
        return `${amount} ${currency}`;
      },
    },
    {
      title: '–û—Ç–∫—É–¥–∞',
      key: 'from',
      render: (_: any, record: InventoryMovement) => {
        if (record.fromWarehouse) return `–°–∫–ª–∞–¥: ${record.fromWarehouse.name}`;
        if (record.fromMachine) return `–ê–≤—Ç–æ–º–∞—Ç: ${record.fromMachine.name}`;
        if (record.counterparty && ['receipt', 'load_machine'].includes(record.movement_type)) {
          return `–ü–æ—Å—Ç–∞–≤—â–∏–∫: ${record.counterparty.name}`;
        }
        return '-';
      },
    },
    {
      title: '–ö—É–¥–∞',
      key: 'to',
      render: (_: any, record: InventoryMovement) => {
        if (record.toWarehouse) return `–°–∫–ª–∞–¥: ${record.toWarehouse.name}`;
        if (record.toMachine) return `–ê–≤—Ç–æ–º–∞—Ç: ${record.toMachine.name}`;
        if (record.counterparty && ['sale', 'unload_machine'].includes(record.movement_type)) {
          return `–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ${record.counterparty.name}`;
        }
        return '-';
      },
    },
    {
      title: '–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç',
      key: 'counterparty',
      render: (_: any, record: InventoryMovement) => {
        return record.counterparty?.name || '-';
      },
    },
    {
      title: '–°–æ–∑–¥–∞–ª',
      key: 'created_by',
      render: (_: any, record: InventoryMovement) => {
        return record.created_by_user?.full_name || record.created_by_user?.username || '-';
      },
    },
    {
      title: '–î–µ–π—Å—Ç–≤–∏—è',
      key: 'actions',
      width: 200,
      render: (_: any, record: InventoryMovement) => (
        <Space>
          <Button
            type="link"
            icon={<EditOutlined />}
            onClick={() => handleEdit(record)}
            disabled={!canCancel(record)}
          />
          
          {canApprove(record) && (
            <Tooltip title="–£—Ç–≤–µ—Ä–¥–∏—Ç—å">
              <Button
                type="link"
                icon={<CheckOutlined />}
                onClick={() => handleApprove(record)}
                style={{ color: '#1890ff' }}
              />
            </Tooltip>
          )}
          
          {canExecute(record) && (
            <Tooltip title="–í—ã–ø–æ–ª–Ω–∏—Ç—å">
              <Button
                type="link"
                icon={<PlayCircleOutlined />}
                onClick={() => handleExecute(record)}
                style={{ color: '#52c41a' }}
              />
            </Tooltip>
          )}
          
          {canCancel(record) && (
            <Tooltip title="–û—Ç–º–µ–Ω–∏—Ç—å">
              <Button
                type="link"
                icon={<CloseOutlined />}
                onClick={() => handleCancel(record)}
                style={{ color: '#ff4d4f' }}
              />
            </Tooltip>
          )}
          
          <Popconfirm
            title="–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –¥–≤–∏–∂–µ–Ω–∏–µ?"
            onConfirm={() => handleDelete(record.id)}
            okText="–î–∞"
            cancelText="–ù–µ—Ç"
          >
            <Button
              type="link"
              danger
              icon={<DeleteOutlined />}
              disabled={!canCancel(record)}
            />
          </Popconfirm>
        </Space>
      ),
    },
  ];

  return (
    <div style={{ padding: isMobile ? '16px' : '24px' }}>
      <div style={{ 
        marginBottom: 24, 
        display: 'flex', 
        justifyContent: 'space-between', 
        alignItems: 'center',
        flexDirection: isMobile ? 'column' : 'row',
        gap: isMobile ? 12 : 0
      }}>
        <Title level={isMobile ? 3 : 2} style={{ 
          margin: 0,
          fontSize: isMobile ? 18 : undefined,
          lineHeight: isMobile ? 1.4 : undefined
        }}>
          <SwapOutlined /> –î–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
        </Title>
        <div style={{ 
          display: 'flex', 
          gap: 8, 
          flexDirection: isMobile ? 'column' : 'row',
          width: isMobile ? '100%' : 'auto'
        }}>
          {selectedRowKeys.length > 0 && (
            <>
              <Button
                type="primary"
                icon={<CheckOutlined />}
                onClick={handleBulkApprove}
                loading={bulkLoading}
                size={isMobile ? 'small' : 'middle'}
                style={{ backgroundColor: '#1890ff' }}
              >
                {isMobile ? `–£—Ç–≤–µ—Ä–¥–∏—Ç—å (${selectedRowKeys.length})` : `–£—Ç–≤–µ—Ä–¥–∏—Ç—å ${selectedRowKeys.length}`}
              </Button>
              <Button
                type="primary"
                icon={<PlayCircleOutlined />}
                onClick={handleBulkExecute}
                loading={bulkLoading}
                size={isMobile ? 'small' : 'middle'}
                style={{ backgroundColor: '#52c41a' }}
              >
                {isMobile ? `–í—ã–ø–æ–ª–Ω–∏—Ç—å (${selectedRowKeys.length})` : `–í—ã–ø–æ–ª–Ω–∏—Ç—å ${selectedRowKeys.length}`}
              </Button>
            </>
          )}
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={handleCreate}
            size={isMobile ? 'small' : 'middle'}
          >
            {isMobile ? '–°–æ–∑–¥–∞—Ç—å' : '–°–æ–∑–¥–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ'}
          </Button>
        </div>
      </div>

      <Card size={isMobile ? 'small' : 'default'}>

        {isMobile ? (
          // –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è - —Å–ø–∏—Å–æ–∫
          <List
            dataSource={movements}
            loading={loading}
            renderItem={(movement: InventoryMovement) => (
              <List.Item
                style={{ 
                  padding: '16px 0',
                  borderBottom: '1px solid #f0f0f0'
                }}
              >
                <div style={{ width: '100%' }}>
                  {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —Ç–∏–ø–æ–º –¥–≤–∏–∂–µ–Ω–∏—è */}
                  <div style={{ 
                    marginBottom: 12,
                    cursor: 'pointer'
                  }}
                  onClick={() => {
                    setSelectedMovement(movement);
                    setDetailDrawerVisible(true);
                  }}
                  >
                    <span 
                      style={{ 
                        fontSize: 18,
                        color: '#1890ff',
                        fontWeight: 'bold',
                        display: 'block',
                        width: '100%',
                        overflow: 'hidden',
                        textOverflow: 'ellipsis',
                        whiteSpace: 'nowrap'
                      }}
                    >
                      {getTypeLabel(movement.movement_type)}
                    </span>
                  </div>

                  {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                  <div style={{ marginBottom: 12 }}>
                    <div style={{ marginBottom: 8 }}>
                      <span style={{ fontSize: 14, fontWeight: 'bold', color: '#666' }}>
                        –î–∞—Ç–∞:
                      </span>
                      <span style={{ fontSize: 14, marginLeft: 8 }}>
                        {dayjs(movement.document_date).format('DD.MM.YYYY HH:mm')}
                      </span>
                    </div>
                    <div style={{ marginBottom: 8 }}>
                      <span style={{ fontSize: 14, fontWeight: 'bold', color: '#666' }}>
                        –°—Ç–∞—Ç—É—Å:
                      </span>
                      <span style={{ fontSize: 14, marginLeft: 8 }}>
                        <Tag color={getStatusColor(movement.status)}>
                          {getStatusLabel(movement.status)}
                        </Tag>
                      </span>
                    </div>
                    <div style={{ marginBottom: 8 }}>
                      <span style={{ fontSize: 14, fontWeight: 'bold', color: '#666' }}>
                        –¢–æ–≤–∞—Ä—ã:
                      </span>
                      <span style={{ fontSize: 14, marginLeft: 8 }}>
                        {movement.items && movement.items.length > 0 
                          ? movement.items.map((item: any, index: number) => (
                              <div key={index} style={{ marginTop: 4 }}>
                                {item.item?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} - {item.quantity} {item.item?.unit || '—à—Ç'}
                              </div>
                            ))
                          : '–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤'
                        }
                      </span>
                    </div>
                    <div style={{ marginBottom: 8 }}>
                      <span style={{ fontSize: 14, fontWeight: 'bold', color: '#666' }}>
                        –°—É–º–º–∞:
                      </span>
                      <span style={{ fontSize: 14, marginLeft: 8 }}>
                        {movement.total_amount 
                          ? `${movement.total_amount} ${movement.currency || 'RUB'}`
                          : '-'
                        }
                      </span>
                    </div>
                    <div style={{ marginBottom: 8 }}>
                      <span style={{ fontSize: 14, fontWeight: 'bold', color: '#666' }}>
                        –û—Ç–∫—É–¥–∞:
                      </span>
                      <span style={{ fontSize: 14, marginLeft: 8 }}>
                        {movement.fromWarehouse ? `–°–∫–ª–∞–¥: ${movement.fromWarehouse.name}` :
                         movement.fromMachine ? `–ê–≤—Ç–æ–º–∞—Ç: ${movement.fromMachine.name}` :
                         movement.counterparty && ['receipt', 'load_machine'].includes(movement.movement_type) 
                           ? `–ü–æ—Å—Ç–∞–≤—â–∏–∫: ${movement.counterparty.name}` : '-'}
                      </span>
                    </div>
                    <div style={{ marginBottom: 8 }}>
                      <span style={{ fontSize: 14, fontWeight: 'bold', color: '#666' }}>
                        –ö—É–¥–∞:
                      </span>
                      <span style={{ fontSize: 14, marginLeft: 8 }}>
                        {movement.toWarehouse ? `–°–∫–ª–∞–¥: ${movement.toWarehouse.name}` :
                         movement.toMachine ? `–ê–≤—Ç–æ–º–∞—Ç: ${movement.toMachine.name}` :
                         movement.counterparty && ['sale', 'unload_machine'].includes(movement.movement_type) 
                           ? `–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ${movement.counterparty.name}` : '-'}
                      </span>
                    </div>
                    <div style={{ marginBottom: 8 }}>
                      <span style={{ fontSize: 14, fontWeight: 'bold', color: '#666' }}>
                        –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:
                      </span>
                      <span style={{ fontSize: 14, marginLeft: 8 }}>
                        {movement.counterparty?.name || '-'}
                      </span>
                    </div>
                    <div style={{ marginBottom: 8 }}>
                      <span style={{ fontSize: 14, fontWeight: 'bold', color: '#666' }}>
                        –°–æ–∑–¥–∞–ª:
                      </span>
                      <span style={{ fontSize: 14, marginLeft: 8 }}>
                        {movement.created_by_user?.full_name || movement.created_by_user?.username || '-'}
                      </span>
                    </div>
                  </div>
                </div>
                
                {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –≤–Ω–∏–∑—É —ç–ª–µ–º–µ–Ω—Ç–∞ */}
                <div style={{ 
                  display: 'flex', 
                  flexWrap: 'wrap',
                  gap: 8,
                  justifyContent: 'flex-end',
                  marginTop: 12,
                  paddingTop: 12,
                  borderTop: '1px solid #f0f0f0'
                }}>
                  <Button 
                    type="text" 
                    icon={<EditOutlined />} 
                    size="small"
                    style={{ 
                      fontSize: '12px',
                      padding: '4px 8px',
                      minWidth: 'auto',
                      height: '32px'
                    }}
                    onClick={() => handleEdit(movement)}
                    disabled={!canCancel(movement)}
                  >
                    –ò–∑–º–µ–Ω–∏—Ç—å
                  </Button>
                  
                  {canApprove(movement) && (
                    <Button
                      type="text"
                      icon={<CheckOutlined />}
                      size="small"
                      style={{ 
                        fontSize: '12px',
                        padding: '4px 8px',
                        minWidth: 'auto',
                        height: '32px',
                        color: '#1890ff'
                      }}
                      onClick={() => handleApprove(movement)}
                    >
                      –£—Ç–≤–µ—Ä–¥–∏—Ç—å
                    </Button>
                  )}
                  
                  {canExecute(movement) && (
                    <Button
                      type="text"
                      icon={<PlayCircleOutlined />}
                      size="small"
                      style={{ 
                        fontSize: '12px',
                        padding: '4px 8px',
                        minWidth: 'auto',
                        height: '32px',
                        color: '#52c41a'
                      }}
                      onClick={() => handleExecute(movement)}
                    >
                      –í—ã–ø–æ–ª–Ω–∏—Ç—å
                    </Button>
                  )}
                  
                  {canCancel(movement) && (
                    <Button
                      type="text"
                      icon={<CloseOutlined />}
                      size="small"
                      style={{ 
                        fontSize: '12px',
                        padding: '4px 8px',
                        minWidth: 'auto',
                        height: '32px',
                        color: '#ff4d4f'
                      }}
                      onClick={() => handleCancel(movement)}
                    >
                      –û—Ç–º–µ–Ω–∏—Ç—å
                    </Button>
                  )}
                  
                  <Popconfirm
                    title="–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –¥–≤–∏–∂–µ–Ω–∏–µ?"
                    onConfirm={() => handleDelete(movement.id)}
                    okText="–î–∞"
                    cancelText="–ù–µ—Ç"
                  >
                    <Button 
                      type="text" 
                      danger 
                      icon={<DeleteOutlined />}
                      size="small"
                      style={{ 
                        fontSize: '12px',
                        padding: '4px 8px',
                        minWidth: 'auto',
                        height: '32px'
                      }}
                      disabled={!canCancel(movement)}
                    >
                      –£–¥–∞–ª–∏—Ç—å
                    </Button>
                  </Popconfirm>
                </div>
              </List.Item>
            )}
          />
        ) : (
          // –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è - —Ç–∞–±–ª–∏—Ü–∞
          <Table
            columns={columns}
            dataSource={movements}
            rowKey="id"
            loading={loading}
            rowSelection={rowSelection}
            pagination={{
              current: pagination.current,
              pageSize: pagination.pageSize,
              total: pagination.total,
              showSizeChanger: true,
              showQuickJumper: true,
              pageSizeOptions: ['100', '200', '500', '800', '1000'],
              showTotal: (total, range) => `${range[0]}-${range[1]} –∏–∑ ${total} –∑–∞–ø–∏—Å–µ–π`,
            }}
            onChange={handleTableChange}
          />
        )}

        {/* Drawer –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */}
        <Drawer
          title={
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              gap: 8,
              minHeight: 'auto',
              padding: '8px 0'
            }}>
              <div style={{ 
                flex: 1,
                minWidth: 0,
                overflow: 'hidden'
              }}>
                <div style={{ 
                  fontSize: 16, 
                  fontWeight: 'bold',
                  whiteSpace: 'nowrap',
                  overflow: 'hidden',
                  textOverflow: 'ellipsis'
                }}>
                  {selectedMovement ? getTypeLabel(selectedMovement.movement_type) : '–î–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤'}
                </div>
                <div style={{ 
                  fontSize: 12, 
                  color: '#999',
                  whiteSpace: 'nowrap',
                  overflow: 'hidden',
                  textOverflow: 'ellipsis'
                }}>
                  –î–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
                </div>
              </div>
            </div>
          }
          placement="right"
          onClose={() => setDetailDrawerVisible(false)}
          open={detailDrawerVisible}
          width="100%"
          styles={{
            header: { 
              padding: '12px 16px',
              minHeight: 'auto',
              borderBottom: '1px solid #f0f0f0'
            },
            body: { 
              padding: '16px',
              paddingBottom: '80px'
            }
          }}
        >
          {selectedMovement && (
            <div>
              {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
              <div style={{ marginBottom: 24 }}>
                <div style={{ marginBottom: 16 }}>
                  <span style={{ fontSize: 14, fontWeight: 'bold', marginBottom: 8, display: 'block' }}>
                    –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
                  </span>
                  <div style={{ fontSize: 14, color: '#666' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                      üìÖ –î–∞—Ç–∞: {dayjs(selectedMovement.document_date).format('DD.MM.YYYY HH:mm')}
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                      üè∑Ô∏è –¢–∏–ø: <Tag color={getTypeColor(selectedMovement.movement_type)}>
                        {getTypeLabel(selectedMovement.movement_type)}
                      </Tag>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                      üìä –°—Ç–∞—Ç—É—Å: <Tag color={getStatusColor(selectedMovement.status)}>
                        {getStatusLabel(selectedMovement.status)}
                      </Tag>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                      üí∞ –°—É–º–º–∞: {selectedMovement.total_amount 
                        ? `${selectedMovement.total_amount} ${selectedMovement.currency || 'RUB'}`
                        : '-'
                      }
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                      üì¶ –¢–æ–≤–∞—Ä—ã: {selectedMovement.items && selectedMovement.items.length > 0 
                        ? selectedMovement.items.map((item: any, index: number) => (
                            <div key={index} style={{ marginTop: 4 }}>
                              {item.item?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} - {item.quantity} {item.item?.unit || '—à—Ç'}
                            </div>
                          ))
                        : '–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤'
                      }
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                      üì§ –û—Ç–∫—É–¥–∞: {selectedMovement.fromWarehouse ? `–°–∫–ª–∞–¥: ${selectedMovement.fromWarehouse.name}` :
                       selectedMovement.fromMachine ? `–ê–≤—Ç–æ–º–∞—Ç: ${selectedMovement.fromMachine.name}` :
                       selectedMovement.counterparty && ['receipt', 'load_machine'].includes(selectedMovement.movement_type) 
                         ? `–ü–æ—Å—Ç–∞–≤—â–∏–∫: ${selectedMovement.counterparty.name}` : '-'}
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                      üì• –ö—É–¥–∞: {selectedMovement.toWarehouse ? `–°–∫–ª–∞–¥: ${selectedMovement.toWarehouse.name}` :
                       selectedMovement.toMachine ? `–ê–≤—Ç–æ–º–∞—Ç: ${selectedMovement.toMachine.name}` :
                       selectedMovement.counterparty && ['sale', 'unload_machine'].includes(selectedMovement.movement_type) 
                         ? `–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ${selectedMovement.counterparty.name}` : '-'}
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                      üë§ –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç: {selectedMovement.counterparty?.name || '-'}
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                      üë®‚Äçüíº –°–æ–∑–¥–∞–ª: {selectedMovement.created_by_user?.full_name || selectedMovement.created_by_user?.username || '-'}
                    </div>
                  </div>
                </div>
              </div>

              {/* –î–µ–π—Å—Ç–≤–∏—è */}
              <div style={{ 
                position: 'fixed', 
                bottom: 0, 
                left: 0, 
                right: 0, 
                background: 'white', 
                padding: '12px 16px',
                borderTop: '1px solid #f0f0f0',
                display: 'flex',
                flexDirection: 'column',
                gap: 8,
                zIndex: 1000,
                boxShadow: '0 -2px 8px rgba(0, 0, 0, 0.1)'
              }}>
                <Button 
                  icon={<EditOutlined />} 
                  style={{ 
                    width: '100%',
                    height: '44px',
                    fontSize: '16px'
                  }}
                  onClick={() => {
                    setDetailDrawerVisible(false);
                    handleEdit(selectedMovement);
                  }}
                  disabled={!canCancel(selectedMovement)}
                >
                  –ò–∑–º–µ–Ω–∏—Ç—å
                </Button>
                
                {canApprove(selectedMovement) && (
                  <Button
                    icon={<CheckOutlined />}
                    style={{ 
                      width: '100%',
                      height: '44px',
                      fontSize: '16px',
                      color: '#1890ff'
                    }}
                    onClick={() => {
                      setDetailDrawerVisible(false);
                      handleApprove(selectedMovement);
                    }}
                  >
                    –£—Ç–≤–µ—Ä–¥–∏—Ç—å
                  </Button>
                )}
                
                {canExecute(selectedMovement) && (
                  <Button
                    icon={<PlayCircleOutlined />}
                    style={{ 
                      width: '100%',
                      height: '44px',
                      fontSize: '16px',
                      color: '#52c41a'
                    }}
                    onClick={() => {
                      setDetailDrawerVisible(false);
                      handleExecute(selectedMovement);
                    }}
                  >
                    –í—ã–ø–æ–ª–Ω–∏—Ç—å
                  </Button>
                )}
                
                {canCancel(selectedMovement) && (
                  <Button
                    icon={<CloseOutlined />}
                    style={{ 
                      width: '100%',
                      height: '44px',
                      fontSize: '16px',
                      color: '#ff4d4f'
                    }}
                    onClick={() => {
                      setDetailDrawerVisible(false);
                      handleCancel(selectedMovement);
                    }}
                  >
                    –û—Ç–º–µ–Ω–∏—Ç—å
                  </Button>
                )}
                
                <Popconfirm
                  title="–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –¥–≤–∏–∂–µ–Ω–∏–µ?"
                  onConfirm={() => {
                    setDetailDrawerVisible(false);
                    handleDelete(selectedMovement.id);
                  }}
                  okText="–î–∞"
                  cancelText="–ù–µ—Ç"
                >
                  <Button 
                    danger 
                    icon={<DeleteOutlined />}
                    style={{ 
                      width: '100%',
                      height: '44px',
                      fontSize: '16px'
                    }}
                    disabled={!canCancel(selectedMovement)}
                  >
                    –£–¥–∞–ª–∏—Ç—å
                  </Button>
                </Popconfirm>
              </div>
            </div>
          )}
        </Drawer>

        <Modal
          title={editingMovement ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ' : '–°–æ–∑–¥–∞—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ'}
          open={modalVisible}
          onCancel={() => {
            setModalVisible(false);
            setMovementItems([]);
            setEditingMovement(null);
            setSelectedMovementType('');
          }}
          footer={null}
          width={isMobile ? '100%' : 800}
          style={isMobile ? { margin: 16, maxWidth: 'calc(100vw - 32px)' } : {}}
        >
          <Form
            form={form}
            layout="vertical"
            onFinish={handleSubmit}
          >
            <Form.Item
              name="document_date"
              label="–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞"
              rules={[{ required: true, message: '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É' }]}
              initialValue={dayjs()}
            >
              <DatePicker
                showTime
                style={{ width: '100%' }}
                placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è"
              />
            </Form.Item>

            <Form.Item
              name="movement_type"
              label="–¢–∏–ø –¥–≤–∏–∂–µ–Ω–∏—è"
              rules={[{ required: true, message: '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–≤–∏–∂–µ–Ω–∏—è' }]}
            >
              <Select 
                placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–≤–∏–∂–µ–Ω–∏—è"
                onChange={handleMovementTypeChange}
              >
                <Option value="receipt">–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</Option>
                <Option value="sale">–ü—Ä–æ–¥–∞–∂–∞</Option>
                <Option value="transfer">–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</Option>
                <Option value="adjustment">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞</Option>
                <Option value="issue">–í—ã–¥–∞—á–∞</Option>
                <Option value="load_machine">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∞</Option>
                <Option value="unload_machine">–í—ã–≥—Ä—É–∑–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∞</Option>
              </Select>
            </Form.Item>

            <Form.Item
              name="status_id"
              label="–°—Ç–∞—Ç—É—Å"
              rules={[{ required: true, message: '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å' }]}
              initialValue={1}
            >
              <Select placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å">
                <Option value={1}>–ß–µ—Ä–Ω–æ–≤–∏–∫</Option>
                <Option value={2}>–£—Ç–≤–µ—Ä–∂–¥–µ–Ω</Option>
              </Select>
            </Form.Item>

            {/* –ü–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
            {shouldShowFromWarehouse() && (
              <Form.Item
                name="from_warehouse_id"
                label="–°–∫–ª–∞–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
                extra={selectedMovementType === 'load_machine' ? '–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–∞' : undefined}
                rules={selectedMovementType === 'transfer' ? [{ required: true, message: '–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è' }] : []}
              >
                <Select placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è" allowClear onChange={handleFromWarehouseChange}>
                  {warehouses.map(warehouse => (
                    <Option key={warehouse.id} value={warehouse.id}>
                      {warehouse.name}
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            )}

            {shouldShowFromMachine() && (
              <Form.Item
                name="from_machine_id"
                label="–ê–≤—Ç–æ–º–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
                rules={
                  ['transfer', 'unload_machine'].includes(selectedMovementType) 
                    ? [{ required: true, message: '–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è' }] 
                    : []
                }
              >
                <Select placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è" allowClear onChange={handleFromMachineChange}>
                  {machines.map(machine => (
                    <Option key={machine.id} value={machine.id}>
                      {machine.name}
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            )}

            {/* –ü–æ–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è */}
            {shouldShowToWarehouse() && (
              <Form.Item
                name="to_warehouse_id"
                label="–°–∫–ª–∞–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è"
                rules={
                  selectedMovementType === 'transfer' 
                    ? [{ required: true, message: '–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è' }]
                    : selectedMovementType === 'receipt'
                    ? [{ 
                        required: !form.getFieldValue('to_machine_id'), 
                        message: '–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è' 
                      }]
                    : []
                }
              >
                <Select placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è" allowClear onChange={handleToWarehouseChange}>
                  {warehouses.map(warehouse => (
                    <Option key={warehouse.id} value={warehouse.id}>
                      {warehouse.name}
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            )}

            {shouldShowToMachine() && (
              <Form.Item
                name="to_machine_id"
                label="–ê–≤—Ç–æ–º–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è"
                rules={
                  ['transfer', 'load_machine'].includes(selectedMovementType) 
                    ? [{ required: true, message: '–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è' }]
                    : selectedMovementType === 'receipt'
                    ? [{ 
                        required: !form.getFieldValue('to_warehouse_id'), 
                        message: '–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏–ª–∏ —Å–∫–ª–∞–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è' 
                      }]
                    : []
                }
              >
                <Select placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è" allowClear onChange={handleToMachineChange}>
                  {machines.map(machine => (
                    <Option key={machine.id} value={machine.id}>
                      {machine.name}
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            )}

            {/* –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç */}
            {shouldShowCounterparty() && (
              <Form.Item
                name="counterparty_id"
                label="–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç"
                extra={selectedMovementType === 'load_machine' ? '–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ. –£–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–∞' : undefined}
                rules={
                  ['receipt', 'sale'].includes(selectedMovementType) 
                    ? [{ required: true, message: '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞' }] 
                    : []
                }
              >
                <Select placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞" allowClear>
                  {counterparties.map(counterparty => (
                    <Option key={counterparty.id} value={counterparty.id}>
                      {counterparty.name}
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            )}

            <Form.Item
              name="currency"
              label="–í–∞–ª—é—Ç–∞"
              rules={[{ required: true, message: '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É' }]}
              initialValue="RUB"
            >
              <Select placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É">
                <Option value="RUB">–†—É–±–ª—å (RUB)</Option>
                <Option value="USD">–î–æ–ª–ª–∞—Ä (USD)</Option>
                <Option value="EUR">–ï–≤—Ä–æ (EUR)</Option>
              </Select>
            </Form.Item>

            <Form.Item
              name="description"
              label="–û–ø–∏—Å–∞–Ω–∏–µ"
            >
              <TextArea
                rows={3}
                placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è"
              />
            </Form.Item>

            {/* –°–µ–∫—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π —Ç–æ–≤–∞—Ä–æ–≤ */}
            <Form.Item label="–ü–æ–∑–∏—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤">
              <div style={{ marginBottom: 16 }}>
                <Button 
                  type="dashed" 
                  onClick={addMovementItem}
                  icon={<PlusOutlined />}
                >
                  –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
                </Button>
              </div>
              
              {movementItems.map((item, index) => (
                <div key={item.id} style={{ 
                  border: '1px solid #d9d9d9', 
                  borderRadius: 6, 
                  padding: 16, 
                  marginBottom: 16,
                  backgroundColor: '#fafafa'
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                    <strong>–ü–æ–∑–∏—Ü–∏—è {index + 1}</strong>
                    <Button 
                      type="text" 
                      danger 
                      icon={<DeleteOutlined />}
                      onClick={() => removeMovementItem(index)}
                    />
                  </div>
                  
                  <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr 1fr', gap: 12 }}>
                    <div>
                      <label style={{ display: 'block', marginBottom: 4, fontSize: 12 }}>–¢–æ–≤–∞—Ä *</label>
                      <Select
                        placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä"
                        value={item.item_id}
                        onChange={(value) => updateMovementItem(index, 'item_id', value)}
                        style={{ width: '100%' }}
                        showSearch
                        filterOption={(input, option) => {
                          if (!option?.children) return false;
                          const searchText = input.toLowerCase();
                          const optionText = option.children.toString().toLowerCase();
                          return optionText.includes(searchText);
                        }}
                        optionFilterProp="children"
                        dropdownStyle={{ maxHeight: 300 }}
                        optionLabelProp="label"
                      >
                        {items.map(itemOption => (
                          <Option 
                            key={itemOption.id} 
                            value={itemOption.id}
                            label={`${itemOption.name} | ${itemOption.sku}`}
                          >
                            <div style={{ 
                              whiteSpace: 'nowrap', 
                              overflow: 'hidden', 
                              textOverflow: 'ellipsis',
                              maxWidth: '100%'
                            }}>
                              {itemOption.name} | {itemOption.sku}
                            </div>
                          </Option>
                        ))}
                      </Select>
                    </div>
                    
                    <div>
                      <label style={{ display: 'block', marginBottom: 4, fontSize: 12 }}>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                      <InputNumber
                        placeholder="–ö–æ–ª-–≤–æ"
                        value={item.quantity}
                        onChange={(value) => updateMovementItem(index, 'quantity', value)}
                        min={0.01}
                        step={0.01}
                        style={{ width: '100%' }}
                      />
                    </div>
                    
                    <div>
                      <label style={{ display: 'block', marginBottom: 4, fontSize: 12 }}>–¶–µ–Ω–∞ *</label>
                      <InputNumber
                        placeholder="–¶–µ–Ω–∞"
                        value={item.price}
                        onChange={(value) => updateMovementItem(index, 'price', value)}
                        min={0}
                        step={0.01}
                        style={{ width: '100%' }}
                      />
                    </div>
                    
                    <div>
                      <label style={{ display: 'block', marginBottom: 4, fontSize: 12 }}>–°—É–º–º–∞</label>
                      <Input
                        value={item.amount ? item.amount : '0.00'}
                        disabled
                        style={{ width: '100%' }}
                      />
                    </div>
                  </div>
                  
                  <div style={{ marginTop: 12 }}>
                    <label style={{ display: 'block', marginBottom: 4, fontSize: 12 }}>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <Input
                      placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏"
                      value={item.description}
                      onChange={(e) => updateMovementItem(index, 'description', e.target.value)}
                    />
                  </div>
                </div>
              ))}
              
              {movementItems.length === 0 && (
                <div style={{ 
                  textAlign: 'center', 
                  padding: 24, 
                  border: '1px dashed #d9d9d9', 
                  borderRadius: 6,
                  color: '#999'
                }}>
                  –ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
                </div>
              )}
            </Form.Item>

            <Form.Item>
              <Space size={isMobile ? 'small' : 'middle'}>
                <Button type="primary" htmlType="submit" size={isMobile ? 'small' : 'middle'}>
                  {editingMovement ? '–û–±–Ω–æ–≤–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å'}
                </Button>
                <Button onClick={() => setModalVisible(false)} size={isMobile ? 'small' : 'middle'}>
                  –û—Ç–º–µ–Ω–∞
                </Button>
              </Space>
            </Form.Item>
          </Form>
        </Modal>
      </Card>
    </div>
  );
};

export default InventoryMovements; 